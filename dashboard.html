<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pocket Money Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
* {box-sizing:border-box; margin:0; padding:0; font-family: Arial, sans-serif;}
body {display:flex; min-height:100vh; background:#f3f4f6; position:relative;}
/* Sidebar */
.sidebar {width:250px; background:#1d4ed8; color:white; display:flex; flex-direction:column;}
.sidebar h2{text-align:center; padding:20px 0; font-size:1.8rem; border-bottom:1px solid rgba(255,255,255,0.2);}
.sidebar a{color:white; text-decoration:none; padding:15px 20px; display:block; transition:0.3s; cursor:pointer;}
.sidebar a:hover{background:#1e40af;}
/* Main content */
.main{flex:1; padding:20px; overflow-y:auto; position:relative;}
.main-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;}
.main-header h1{font-size:1.8rem; color:#1f2937;}
.main-header button{padding:8px 16px; background:#ef4444; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;}
.main-header button:hover{background:#dc2626;}
/* Cards */
.card{background:white; padding:20px; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.1); margin-bottom:20px; display:none; opacity:0; transform:translateY(20px); transition: opacity 0.5s, transform 0.5s;}
.card.show{display:block; opacity:1; transform:translateY(0);}
.summary-card{display:flex; justify-content:space-between; margin-bottom:20px;}
.summary-card .summary{flex:1; margin-right:10px; padding:15px; border-radius:12px; background:#e0f2fe; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.1);}
.summary-card .summary:last-child{margin-right:0;}
.summary-card .summary h2{font-size:1.5rem; color:#1d4ed8; margin-bottom:5px;}
.summary-card .summary p{font-size:1rem; color:#1f2937;}
table{width:100%; border-collapse:collapse; transition:all 0.3s;}
table th, table td{border:1px solid #d1d5db; padding:10px; text-align:left; cursor:pointer;}
table th{background:#1d4ed8; color:white;}
table tr:hover{background:#e0e7ff;}
input{padding:8px 10px; margin-bottom:10px; border:1px solid #d1d5db; border-radius:6px; width:100%; transition:0.3s;}
input:focus{border-color:#1d4ed8; outline:none; box-shadow:0 0 5px rgba(29,78,216,0.5);}
select{padding:8px 10px; margin-bottom:10px; border:1px solid #d1d5db; border-radius:6px; width:100%;}
button.action-btn{padding:8px 12px; background:#1d4ed8; color:white; border:none; border-radius:6px; cursor:pointer; transition:0.3s;}
button.action-btn:hover{background:#1e40af;}
#loading{position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:flex; justify-content:center; align-items:center; z-index:1000; display:none; opacity:0; transition:opacity 0.3s;}
#loading.show{display:flex; opacity:1;}
.loader{border:6px solid #f3f3f3; border-top:6px solid #1d4ed8; border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
.profile-pic{width:100px; height:100px; border-radius:50%; object-fit:cover; margin-bottom:15px;}
#alerts{position:fixed; top:20px; right:20px; background:#fef3c7; color:#b45309; padding:15px 20px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); opacity:0; pointer-events:none; transition:opacity 0.5s; z-index:9999;}
#alerts.show{opacity:1; pointer-events:auto;}
.pagination{margin-top:10px; display:flex; justify-content:center; gap:5px;}
.pagination button{padding:5px 10px; border:none; border-radius:5px; cursor:pointer; background:#1d4ed8; color:white;}
.pagination button:hover{background:#1e40af;}
@media(max-width:768px){body{flex-direction:column;}.sidebar{width:100%; flex-direction:row; overflow-x:auto;}.sidebar a{flex:1; text-align:center;}.profile-pic{width:80px;height:80px;}.summary-card{flex-direction:column;}.summary-card .summary{margin-bottom:10px; margin-right:0;}}
</style>
</head>
<body>

<div id="loading"><div class="loader"></div></div>
<div id="alerts"></div>

<div class="sidebar">
    <h2>Pocket Money</h2>
    <a onclick="showSection('dashboard')">Dashboard Summary</a>
    <a onclick="showSection('students')">Students</a>
    <a onclick="showSection('add-student')">Add Student</a>
    <a onclick="showSection('transactions')">Transactions</a>
    <a onclick="showSection('history')">History</a>
    <a onclick="showSection('reports')">Reports</a>
    <a onclick="showSection('profile')">Profile</a>
    <a onclick="logout()">Logout</a>
</div>

<div class="main">
    <div class="main-header">
        <h1>Pocket Money Dashboard</h1>
        <button onclick="logout()">Logout</button>
    </div>

    <!-- Dashboard Summary -->
    <div class="card" id="dashboard-section">
        <h3>System Summary & Chart</h3>
        <div class="summary-card">
            <div class="summary"><h2 id="total-money">0 RWF</h2><p>Total Money</p></div>
            <div class="summary"><h2 id="total-students">0</h2><p>Total Students</p></div>
            <div class="summary"><h2 id="low-balance">0</h2><p>Low Balance</p></div>
        </div>
        <canvas id="balanceChart" style="max-width:100%; height:300px;"></canvas>
    </div>

    <!-- Students Section -->
    <div class="card" id="students-section">
        <h3>Students List</h3>
        <input type="text" id="student-search" placeholder="Search by name" oninput="renderStudentsTable()">
        <table id="students-table">
            <thead><tr><th>ID</th><th>Name</th><th>Amount</th></tr></thead>
            <tbody></tbody>
        </table>
        <div class="pagination" id="students-pagination"></div>
    </div>

    <!-- Add Student Section -->
    <div class="card" id="add-student-section">
        <h3>Add New Student</h3>
        <input type="text" id="new-student-name" placeholder="Enter full name">
        <input type="number" id="new-student-amount" placeholder="Enter initial amount (default 0)">
        <button class="action-btn" onclick="addStudent()">Add Student</button>
    </div>

    <!-- Transactions Section -->
    <div class="card" id="transactions-section">
        <h3>Make Transaction</h3>
        <input type="text" id="transaction-search" placeholder="Search student..." oninput="renderTransactionTable()">
        <table id="transaction-table">
            <thead><tr><th>ID</th><th>Name</th><th>Amount</th></tr></thead>
            <tbody></tbody>
        </table>
        <label for="transaction-type">Transaction Type</label>
        <select id="transaction-type"><option value="add">Add Money</option><option value="deduct">Deduct Money</option></select>
        <label for="transaction-amount">Amount</label>
        <input type="number" id="transaction-amount" placeholder="Enter amount">
        <button class="action-btn" onclick="submitTransaction()">Submit</button>
    </div>

    <!-- History Section -->
    <div class="card" id="history-section">
        <h3>Transaction History</h3>
        <input type="text" id="history-search" placeholder="Search by student name" oninput="renderHistoryTable()">
        <table id="history-table">
            <thead><tr><th>Date</th><th>Student</th><th>Type</th><th>Amount</th><th>Balance After</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Reports Section -->
    <div class="card" id="reports-section">
        <h3>Reports</h3>
        <div class="summary-card">
            <div class="summary"><h2 id="report-total-money">0 RWF</h2><p>Total Money</p></div>
            <div class="summary"><h2 id="report-total-students">0</h2><p>Total Students</p></div>
            <div class="summary"><h2 id="report-low-balance">0</h2><p>Low Balance</p></div>
        </div>
        <canvas id="reportChart" style="max-width:100%; height:300px;"></canvas>
        <h4>Transaction History</h4>
        <table id="report-table">
            <thead><tr><th>Date</th><th>Student</th><th>Type</th><th>Amount</th><th>Balance After</th></tr></thead>
            <tbody></tbody>
        </table>
        <button class="action-btn" onclick="printReport()">Print Report</button>
    </div>

    <!-- Profile Section -->
    <div class="card" id="profile-section">
        <h3>Profile</h3>
        <img src="https://i.pravatar.cc/100" class="profile-pic" alt="Profile Picture">
        <p>Name: NIYITANGA Eric</p>
    </div>
</div>

<script>
// ------------------- DATA -------------------
let students = JSON.parse(localStorage.getItem('students')) || {};
let transactionHistory = JSON.parse(localStorage.getItem('transactionHistory')) || [];
let studentHistory = JSON.parse(localStorage.getItem('studentHistory')) || {};
let lastStudentId = parseInt(localStorage.getItem('lastStudentId')) || 0;
let reportChart=null;
let balanceChart=null;

// ------------------- UTILITY -------------------
function showLoading(show){document.getElementById('loading').classList.toggle('show',show);}
function showAlert(msg){const a=document.getElementById('alerts'); a.textContent=msg; a.classList.add('show'); setTimeout(()=>{a.classList.remove('show');},3000);}
function saveData(){localStorage.setItem('students',JSON.stringify(students)); localStorage.setItem('transactionHistory',JSON.stringify(transactionHistory)); localStorage.setItem('studentHistory',JSON.stringify(studentHistory)); localStorage.setItem('lastStudentId',lastStudentId);}
function getRandomColor(seed){let hash=0; for(let i=0;i<seed.length;i++){hash=seed.charCodeAt(i)+((hash<<5)-hash);} let c=(hash&0x00FFFFFF).toString(16).toUpperCase(); return "#"+"00000".substring(0,6-c.length)+c;}

// ------------------- SECTION NAV -------------------
function showSection(section){
    showLoading(true);
    setTimeout(()=>{
        document.querySelectorAll('.card').forEach(c=>c.classList.remove('show'));
        document.getElementById(section+'-section').classList.add('show');
        updateSummary();
        renderStudentsTable();
        renderTransactionTable();
        renderHistoryTable();
        renderReports();
        showLoading(false);
    },200);
}
function logout(){if(confirm('Logout?')) window.location.href='index.html';}

// ------------------- SUMMARY -------------------
function updateSummary(){
    let total=0, low=0;
    Object.values(students).forEach(s=>{total+=s.amount||0; if((s.amount||0)<5000) low++;});
    document.getElementById('total-money').textContent=total+' RWF';
    document.getElementById('total-students').textContent=Object.keys(students).length;
    document.getElementById('low-balance').textContent=low;
    if(balanceChart){balanceChart.data.datasets[0].data=Object.values(students).map(s=>s.amount||0); balanceChart.data.labels=Object.values(students).map(s=>s.name); balanceChart.update();}
    else{
        const ctx=document.getElementById('balanceChart').getContext('2d');
        balanceChart=new Chart(ctx,{type:'line',data:{labels:Object.values(students).map(s=>s.name),datasets:[{label:'Balance',data:Object.values(students).map(s=>s.amount||0),fill:false,borderColor:'#1d4ed8',tension:0.3,pointBackgroundColor:'#1d4ed8'}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
    }
}

// ------------------- STUDENTS -------------------
let studentPerPage=25,currentPage=1;
function renderStudentsTable(){
    const tbody=document.getElementById('students-table').querySelector('tbody');
    const search=document.getElementById('student-search').value.toLowerCase();
    let filtered=Object.entries(students).filter(([id,s])=>s.name.toLowerCase().includes(search));
    let totalPages=Math.ceil(filtered.length/studentPerPage);
    if(currentPage>totalPages) currentPage=1;
    let pageData=filtered.slice((currentPage-1)*studentPerPage,currentPage*studentPerPage);
    tbody.innerHTML='';
    pageData.forEach(([id,s])=>{tbody.insertAdjacentHTML('beforeend',`<tr><td>${id}</td><td>${s.name}</td><td>${s.amount||0}</td></tr>`);});
    // Pagination
    const pagDiv=document.getElementById('students-pagination'); pagDiv.innerHTML='';
    for(let i=1;i<=totalPages;i++){let btn=document.createElement('button'); btn.textContent=i; btn.onclick=()=>{currentPage=i; renderStudentsTable();}; pagDiv.appendChild(btn);}
}

// ------------------- ADD STUDENT -------------------
function addStudent(){
    const name=document.getElementById('new-student-name').value.trim();
    let amt=parseInt(document.getElementById('new-student-amount').value);
    if(!amt) amt=0;
    if(!name){showAlert('Enter student name'); return;}
    lastStudentId++;
    students[lastStudentId]={name:name,amount:amt};
    saveData();
    renderStudentsTable(); renderTransactionTable(); updateSummary();
    document.getElementById('new-student-name').value=''; document.getElementById('new-student-amount').value='';
    showAlert(`Student ${name} added successfully!`);
}

// ------------------- TRANSACTIONS -------------------
function renderTransactionTable(){
    const tbody=document.getElementById('transaction-table').querySelector('tbody');
    const search=document.getElementById('transaction-search').value.toLowerCase();
    tbody.innerHTML='';
    Object.entries(students).filter(([id,s])=>s.name.toLowerCase().includes(search)).forEach(([id,s])=>{tbody.insertAdjacentHTML('beforeend',`<tr onclick="selectTransactionStudent(${id})"><td>${id}</td><td>${s.name}</td><td>${s.amount||0}</td></tr>`);});
}
let selectedStudentId=null;
function selectTransactionStudent(id){selectedStudentId=id; showAlert(`Selected ${students[id].name}`);}
function submitTransaction(){
    if(!selectedStudentId){showAlert('Select a student'); return;}
    let type=document.getElementById('transaction-type').value;
    let amt=parseInt(document.getElementById('transaction-amount').value);
    if(!amt || amt<=0){showAlert('Enter valid amount'); return;}
    if(type==='deduct' && (students[selectedStudentId].amount||0)<amt){showAlert('Insufficient balance'); return;}
    students[selectedStudentId].amount=type==='add'? (students[selectedStudentId].amount||0)+amt : (students[selectedStudentId].amount||0)-amt;
    // Update history
    const date=new Date().toLocaleString();
    transactionHistory.push({date:date, student:students[selectedStudentId].name,type:type==='add'?'Add':'Deduct',amount:amt,balance:students[selectedStudentId].amount});
    if(!studentHistory[selectedStudentId]) studentHistory[selectedStudentId]=[];
    studentHistory[selectedStudentId].push({date:date,balance:students[selectedStudentId].amount});
    saveData(); renderTransactionTable(); renderHistoryTable(); updateSummary(); renderReports();
    document.getElementById('transaction-amount').value=''; showAlert('Transaction successful!');
}

// ------------------- HISTORY -------------------
function renderHistoryTable(){
    const tbody=document.getElementById('history-table').querySelector('tbody');
    const search=document.getElementById('history-search').value.toLowerCase();
